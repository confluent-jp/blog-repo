<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: November 2, 2023 --><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Wowchemy 5.9.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/community/css/vendor-bundle.min.047268c6dd09ad74ba54a0ba71837064.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/community/css/wowchemy.7eaca94f0cfe2f9115699dbdb8fbc775.css><link rel=stylesheet href=/community/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/community/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-GK7TWGR09R"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-GK7TWGR09R",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-PV88WTBF")</script><meta name=author content="hashi"><meta name=description content="ksqlDBにおけるストリーム処理の概念と、ストリーム処理でTopicのKeyを扱う方法について。"><link rel=alternate hreflang=ja-jp href=https://confluent-jp.github.io/community/blog/handling-keys-in-ksql/><link rel=canonical href=https://confluent-jp.github.io/community/blog/handling-keys-in-ksql/><link rel=icon type=image/png href=/community/media/icon_hubade5daff97c80353b10ab16b141ee15_5385_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/community/media/icon_hubade5daff97c80353b10ab16b141ee15_5385_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#1565c0"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@wowchemy"><meta property="twitter:creator" content="@wowchemy"><meta property="twitter:image" content="https://confluent-jp.github.io/community/blog/handling-keys-in-ksql/featured.png"><meta property="og:type" content="website"><meta property="og:site_name" content="Confluent Japan Community"><meta property="og:url" content="https://confluent-jp.github.io/community/blog/handling-keys-in-ksql/"><meta property="og:title" content="ストリーム処理でKafka TopicのKeyを扱う in KSQL | Confluent Japan Community"><meta property="og:description" content="ksqlDBにおけるストリーム処理の概念と、ストリーム処理でTopicのKeyを扱う方法について。"><meta property="og:image" content="https://confluent-jp.github.io/community/blog/handling-keys-in-ksql/featured.png"><meta property="og:locale" content="ja-jp"><meta property="article:published_time" content="2023-11-02T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-02T00:00:00+00:00"><title>ストリーム処理でKafka TopicのKeyを扱う in KSQL | Confluent Japan Community</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=86d518847ed4151c3b4eedfa73a290c8><script src=/community/js/wowchemy-init.min.e6724bea461adf2acc4820665a329eca.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/community/>Confluent Japan Community</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/community/>Confluent Japan Community</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/community/#top><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/community/#blog><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/#talk><span>Talk</span></a></li><li class=nav-item><a class=nav-link href=/community/#demo><span>Demo</span></a></li><li class=nav-item><a class=nav-link href=/community/#publication><span>Publication</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://twitter.com/confluentinc data-toggle=tooltip data-placement=bottom title="Follow me on Twitter" target=_blank rel=noopener aria-label="Follow me on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://github.com/confluent-jp target=_blank rel=noopener aria-label=GitHub><i class="fab fa-GitHub" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span>
</a><a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span>
</a><a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>ストリーム処理でKafka TopicのKeyを扱う in KSQL</h1><div class=article-metadata><div><span class=author-highlighted><a href=/community/authors/hashi/>hashi</a></span></div><span class=article-date>Nov 2, 2023
</span><span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/community/category/blog/>Blog</a>, <a href=/community/category/ksqdb/>ksqDB</a></span></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:628px;max-height:512px><div style=position:relative><img src=/community/blog/handling-keys-in-ksql/featured_hu153fa79259aca095d62b6e2f2af01704_40746_c764e392362ff24ddbf6f0f58a10c39a.webp width=628 height=512 alt class=featured-image></div></div><div class=article-container><div class=article-style><h2 id=はじめに>はじめに</h2><p>Kafkaをベースとしたストリーム処理では、Kafka Topicに流れるイベントを取り込み、処理後に別のTopicに書き込む事を繋げる事によりパイプラインを構築します。ksqlDBの様なストリーム処理基盤はこの処理を開発者から隠蔽化し、SQLを用いてそのロジックのみに注力できるよう補助してくれます。</p><p>一方、この隠蔽化によってksqlDBが行なっている内部処理の多くは開発者にはタッチする事が出来ず、出来た場合でも直感的に扱えない事も多くあります。Kafka TopicのKeyもその一つです。</p><p>今回はksqlDBにおけるStreamの概念と、Topic Keyを扱う方法について説明します。</p><h2 id=streamとtable>StreamとTable</h2><p>ksqlDBのストリーム処理では、Topicと紐付けるデータモデルを定義しそのモデルに対してクエリを実行する形でデータにアクセスします。具体的には<code>Stream</code>と<code>Table</code>で：</p><ul><li><strong>STREAM</strong> - Topicを流れるイベントを、時系列を維持したデータの流れとして体現。ステートレス。</li><li><strong>TABLE</strong> - Topicを流れるイベントからKey単位でデータの最新状態をマテリアライズ。ステートフル。</li></ul><p>同じKafka上で扱うデータですが、モデルによってksqlDBにおける扱いも、そしてそれを支える内部の仕組みも異なります。<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> ただksqlDBのクエリ上はどちらも<code>CREATE</code>構文を利用してSQL同様の手順で作成します。例としてStreamの定義のサンプルは以下の様になります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>Clickstream</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USERID</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>REMOTE_USER</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TIME</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_TIME</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>REQUEST</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATUS</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BYTES</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>REFERRER</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AGENT</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>KAFKA_TOPIC</span><span class=o>=</span><span class=s1>&#39;datagen-topic&#39;</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_FORMAT</span><span class=o>=</span><span class=s1>&#39;JSON&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>ここでは<code>datagen-topic</code>というJSONでシリアライズされたTopicに対して<code>Clickstream</code>という名前のStreamデータモデルを定義しています。</p><h4 id=csasとctas>CSASとCTAS</h4><p>Topicをモデル化したStreamやTableを定義したとして、今度はそのモデルに対して処理をする必要性が出てきます。一般的なデータフロープログラミングのモデルではプログラム内で処理をチェイニングした結果を別Topicに出力しますが、SQLにはそのような構文モデルはありません。一方リレーショナルDBではストアドプロシージャを利用しますが、DB毎にその仕様は異なります。</p><p>ksqlDBではもっと汎用的な<code>SELECT</code>と<code>CREATE STREAM</code>を組み合わせる事により処理とストアを結びつけます。具体的には<code>CREATE STREAM AS SELECT</code>構文を利用します。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>EventsWithoutKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=n>KAFKA_TOPIC</span><span class=o>=</span><span class=s1>&#39;404events&#39;</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_FORMAT</span><span class=o>=</span><span class=s1>&#39;JSON&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USERID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_TIME</span><span class=w> </span><span class=n>TIME_IN_INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATUS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BYTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Clickstream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>STATUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;404&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EMIT</span><span class=w> </span><span class=n>CHANGES</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>ここでは前述した<code>Clickstream</code>というStreamから必要なカラムを指定してSELECTした結果を新たなStreamとして定義する処理です。ここではWHERE句を利用してフィルタリングした結果のみ抽出し、かつ新たに<code>404events</code>というTopicに対して出力しています。物理的には<code>Clickstream</code>に紐付く<code>datagen-topic</code> Topicにあるデータが変換/加工され<code>404events</code>という新たなTopicに登録されます。</p><p>当然この構文はksqlDBでのストリーム処理には頻出構文であり、CSAS (<code>CREATE STREAM AS SELECT</code>)、CTAS (<code>CREATE TABLE AS SELECT</code>)と呼ばれます。</p><h4 id=keyとデータモデル>Keyとデータモデル</h4><p><code>CREATE STREAM</code>と<code>CREATE TABLE</code>ではTopicのKeyの扱い方が異なります。</p><p>以前のバージョンではStreamでもTableでも<code>ROWKEY</code>という名称でTopicのKeyに紐づくフィールドをモデルに追加します。この<code>ROWKEY</code>は物理的にはTopicのKeyでありながら、Valueを扱うksqlDBから参照出来るという、他のフィールドとは扱いも振る舞いも異なります。また、コミュニティではこの勝手に追加される<code>ROWKEY</code>というフィールドの扱い方に関して多くの混乱を招きました。ストリーム処理をSQLで処理をする上では直感的では無いという判断でした。</p><p>このKeyの扱い方は<a href=https://www.confluent.io/blog/ksqldb-0-10-updates-key-columns/#keyless-streams target=_blank rel=noopener>ksqlDB 0.10で大きく変わりました</a>。これは一律ではなくStreamとTableで定義を変える事で：</p><ul><li><strong>CREATE TABLE</strong> - 明示的にKeyを指定する必要があり、それには<code>PRIMARY KEY</code>と指定するフィールドが必要。</li><li><strong>CREATE STREAM</strong> - キーをそもそも指定しない。</li></ul><p>このアプローチはTABLEの構文としても自然であり、かつSTREAMを扱う際にはKeyが存在すらしないという潔いものです。結果としてこの変更と思想が以降のksqlDBのコミュニティに広がりました。</p><h2 id=streamとkey>StreamとKey</h2><p>それでもStreamでKeyを扱いたいというのが本エントリの主旨です。</p><p>実際にStreamでKeyを指定する必要性がある場合は存在し、具体的には<a href=https://docs.ksqldb.io/en/latest/developer-guide/joins/partition-data/#keys target=_blank rel=noopener>JOINの際にはKey指定したものしかJOIN出来ません</a>。この為StreamでもKeyを指定する事は可能になっています。</p><p>具体的にはフィールドに<code>Key</code>と指定する事により、そのフィールドをValueの一部ではなくKeyとして扱います。先程の<code>CREATE STREAM</code>を例に取ると：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>ClickstreamWithKey</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w> </span><span class=k>Key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USERID</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>REMOTE_USER</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TIME</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_TIME</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>REQUEST</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATUS</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BYTES</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>REFERRER</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AGENT</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>KAFKA_TOPIC</span><span class=o>=</span><span class=s1>&#39;datagen-topic&#39;</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_FORMAT</span><span class=o>=</span><span class=s1>&#39;JSON&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>同じTopicを参照していますが、ここで生成されるStreamにはレコードKeyに<code>IP</code>が指定され、と言うよりValueからKeyに移動します。</p><p>この振る舞いを実際に確認するには<code>CSAS</code>で再定義したものに新たなTopicを割り当て、その結果を比較する必要があります。これら2つのStreamに以下のCSASを適用すると：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>TransformedEvents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=n>KAFKA_TOPIC</span><span class=o>=</span><span class=s1>&#39;events&#39;</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_FORMAT</span><span class=o>=</span><span class=s1>&#39;JSON&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USERID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_TIME</span><span class=w> </span><span class=n>TIME_IN_INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATUS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BYTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Clickstream</span><span class=w> </span><span class=c1>-- Keyがある方はClickstreamWithKeyと指定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>EMIT</span><span class=w> </span><span class=n>CHANGES</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>通常の<code>CREATE STREAM</code>で生成した場合、Topicには<figure><div class="d-flex justify-content-center"><div class=w-100><img alt="CREATE STREAM without Key - Key" srcset="/community/media/blogs/handling-keys-in-ksql/keyless-key_huc56dfe2a7de818cca4a10762291b8507_8953_ecfa51475f8ff3a419613f69c09fc1ca.webp 400w,
/community/media/blogs/handling-keys-in-ksql/keyless-key_huc56dfe2a7de818cca4a10762291b8507_8953_8f8d9bc9cc3660c85c6b11ccd6ac1e19.webp 760w,
/community/media/blogs/handling-keys-in-ksql/keyless-key_huc56dfe2a7de818cca4a10762291b8507_8953_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src=/community/media/blogs/handling-keys-in-ksql/keyless-key_huc56dfe2a7de818cca4a10762291b8507_8953_ecfa51475f8ff3a419613f69c09fc1ca.webp width=760 height=107 loading=lazy data-zoomable></div></div></figure><figure><div class="d-flex justify-content-center"><div class=w-100><img alt="CREATE STREAM without Key - Value" srcset="/community/media/blogs/handling-keys-in-ksql/keyless-value_hub62a909993c35cf3e9faf6edd4064341_22835_acd0bf529162173000fa253a496ad6ca.webp 400w,
/community/media/blogs/handling-keys-in-ksql/keyless-value_hub62a909993c35cf3e9faf6edd4064341_22835_417c284ab3b5a3aea8d4eea4c5356152.webp 760w,
/community/media/blogs/handling-keys-in-ksql/keyless-value_hub62a909993c35cf3e9faf6edd4064341_22835_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src=/community/media/blogs/handling-keys-in-ksql/keyless-value_hub62a909993c35cf3e9faf6edd4064341_22835_acd0bf529162173000fa253a496ad6ca.webp width=760 height=227 loading=lazy data-zoomable></div></div></figure>となり、<code>Key</code>を指定したStreamに対する<code>CSAS</code>の結果は<figure><div class="d-flex justify-content-center"><div class=w-100><img alt="CREATE STREAM with Key - Key" srcset="/community/media/blogs/handling-keys-in-ksql/withkey-key_hu9e69a7ba4db462c29de818c1fc309f8f_10708_df18645726bb440f01116ec0287989d7.webp 400w,
/community/media/blogs/handling-keys-in-ksql/withkey-key_hu9e69a7ba4db462c29de818c1fc309f8f_10708_dea25a34e37ae0696ff0e8d268b7112b.webp 760w,
/community/media/blogs/handling-keys-in-ksql/withkey-key_hu9e69a7ba4db462c29de818c1fc309f8f_10708_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src=/community/media/blogs/handling-keys-in-ksql/withkey-key_hu9e69a7ba4db462c29de818c1fc309f8f_10708_df18645726bb440f01116ec0287989d7.webp width=760 height=122 loading=lazy data-zoomable></div></div></figure><figure><div class="d-flex justify-content-center"><div class=w-100><img alt="CREATE STREAM with Key - Value" srcset="/community/media/blogs/handling-keys-in-ksql/withkey-value_hu0d59ac08b4969ca3f4e3160a7bf26c4e_19880_0336fd2f085a987b996ec3e8ca08ed91.webp 400w,
/community/media/blogs/handling-keys-in-ksql/withkey-value_hu0d59ac08b4969ca3f4e3160a7bf26c4e_19880_4d3e8ddaab41154738ee4a263ffa6f16.webp 760w,
/community/media/blogs/handling-keys-in-ksql/withkey-value_hu0d59ac08b4969ca3f4e3160a7bf26c4e_19880_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src=/community/media/blogs/handling-keys-in-ksql/withkey-value_hu0d59ac08b4969ca3f4e3160a7bf26c4e_19880_0336fd2f085a987b996ec3e8ca08ed91.webp width=760 height=211 loading=lazy data-zoomable></div></div></figure>となります。IPがTopicのKeyに移っている事が確認できます。</p><h2 id=keyをvalueの中にも持つ>KeyをValueの中にも持つ</h2><p>先述した通り、StreamにおいてKeyを扱う事は混乱を招く恐れがある為、JOIN等明確な利用がある場合のみに利用する事が推奨されます。それでもJoinもするがValueの中でもKeyを参照する、つまりksqlDB内でKeyを参照したいというユースケースも存在します。</p><p>この場合、KeyのコピーをValue内に持たせるする必要がありますが、ハックに近い対応が必要となります。</p><p>KeyをValueにコピーする関数は存在し、<a href=https://docs.ksqldb.io/en/latest/developer-guide/ksqldb-reference/scalar-functions/#as_value target=_blank rel=noopener>AS_VALUE</a>関数を利用すればコピー出来ます。</p><p>しかしながら、<code>AS_VALUE</code>はTableを前提とした関数であり、Tableには明示的に PRIMARYKEYを指定するのでKeyとそのフィールド名も参照出来ますが、Streamの場合にはKeyは必須ではありません。また、先程の<code>Key</code>を利用した<code>CREATE STREAM</code>の結果にあるように、Keyには値のみ、ここでは<code>IP</code>で指定した値のみが入っています。なので<code>AS_VALUE</code>を<code>ROWKEY</code>に対して実行したいのですが：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>TransformedEventsWithKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=n>KAFKA_TOPIC</span><span class=o>=</span><span class=s1>&#39;events-with-key&#39;</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_FORMAT</span><span class=o>=</span><span class=s1>&#39;JSON&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AS_VALUE</span><span class=p>(</span><span class=n>ROWKEY</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>IP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USERID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_TIME</span><span class=w> </span><span class=n>TIME_IN_INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATUS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BYTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>ClickstreamWithKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EMIT</span><span class=w> </span><span class=n>CHANGES</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>このクエリは構文エラーとなります。<code>AS_VALUE</code>はTableの<code>PRIMARY KEY</code>は引数として受け付けますが、値だけのROWKEYは受け付けません。つまり<code>AS_VALUE</code>は通常の使用法ではStreamに対しては利用出来ません。<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p>ハックとしての解答は以下になります：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=n>STREAM</span><span class=w> </span><span class=n>TransformedEventsWithKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=n>KAFKA_TOPIC</span><span class=o>=</span><span class=s1>&#39;events-with-key&#39;</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_FORMAT</span><span class=o>=</span><span class=s1>&#39;JSON&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IP</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ROWKEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AS_VALUE</span><span class=p>(</span><span class=n>IP</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>IP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>USERID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_TIME</span><span class=w> </span><span class=n>TIME_IN_INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATUS</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BYTES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>ClickstreamWithKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EMIT</span><span class=w> </span><span class=n>CHANGES</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><code>ROWKEY</code>に対して<code>IP</code>というフィールド名を割り当て、そのフィールドを<code>AS_VALUE</code>で利用する方法になります。上記クエリを分解解釈すると以下となります：</p><ul><li>StreamにはないPrimary Keyのフィールドを<code>IP</code>として明示的に指定。</li><li>そのフィールドを<code>AS_VALUE</code>で参照。この際元々あるフィールドと同名で定義。</li></ul><p>妙な構文になりますが、結果は：<figure><div class="d-flex justify-content-center"><div class=w-100><img alt="CREATE STREAM with Key and Value - Key" srcset="/community/media/blogs/handling-keys-in-ksql/withkeyvalue-key_hub6bc2ca3d3546dcb19b585c16576dd32_11126_5546ce75955df420911d529bdf97456e.webp 400w,
/community/media/blogs/handling-keys-in-ksql/withkeyvalue-key_hub6bc2ca3d3546dcb19b585c16576dd32_11126_0a613f4b5ee7def537bab3b886a6b798.webp 760w,
/community/media/blogs/handling-keys-in-ksql/withkeyvalue-key_hub6bc2ca3d3546dcb19b585c16576dd32_11126_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src=/community/media/blogs/handling-keys-in-ksql/withkeyvalue-key_hub6bc2ca3d3546dcb19b585c16576dd32_11126_5546ce75955df420911d529bdf97456e.webp width=760 height=123 loading=lazy data-zoomable></div></div></figure><figure><div class="d-flex justify-content-center"><div class=w-100><img alt="CREATE STREAM with Key and Value - Value" srcset="/community/media/blogs/handling-keys-in-ksql/withkeyvalue-value_hu40264929708375a514000712072b6e5e_22598_b0bd9f06a5173545c9ab68c6ef7e0eea.webp 400w,
/community/media/blogs/handling-keys-in-ksql/withkeyvalue-value_hu40264929708375a514000712072b6e5e_22598_123f4688e4a7d7b0ddfa6a8b9e5fbce5.webp 760w,
/community/media/blogs/handling-keys-in-ksql/withkeyvalue-value_hu40264929708375a514000712072b6e5e_22598_1200x1200_fit_q75_h2_lanczos_3.webp 1200w" src=/community/media/blogs/handling-keys-in-ksql/withkeyvalue-value_hu40264929708375a514000712072b6e5e_22598_b0bd9f06a5173545c9ab68c6ef7e0eea.webp width=760 height=230 loading=lazy data-zoomable></div></div></figure>と期待通りの結果となります。</p><h2 id=おわりに>おわりに</h2><p>このハック的なアプローチを見ると「ksqlDBは面倒くさい。直感的ではない。」と思うかも知れません。確かにハックだけを見るとその通りで、無意味な制約のようにも思えます。しかしながらこれには背景があり、より直感的なデータモデル定義へと変更した事による副作用である事を理解して頂ければと思います。また、ksqlDB、というよりデータフロー処理内でKeyを参照するというのは特殊な要件です。このハックを怪しい要件/ロジックのスメルと捉える事もできます。</p><p>何より、やや面倒くさいksqlDBにおけるKeyの扱いを理解すると、ksqlDBの仕組みやデータモデルへの理解が深まります。ksqlDBの裏側を少し垣間見る機会と思って頂ければ幸いです。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>実際のステート管理はksqlDBが内部で利用する<a href=https://docs.confluent.io/platform/current/streams/architecture.html#state target=_blank rel=noopener>Kafka Streamsの仕組み</a>を利用している。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>これはStreamの構文だからエラーではなく、そもそも<code>AS_VALUE</code>に<code>ROWKEY</code>を指定出来ないという仕様によるもの。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=article-tags><a class="badge badge-light" href=/community/tag/stream-processing/>Stream Processing</a>
<a class="badge badge-light" href=/community/tag/topic/>Topic</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fconfluent-jp.github.io%2Fcommunity%2Fblog%2Fhandling-keys-in-ksql%2F&amp;text=%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E5%87%A6%E7%90%86%E3%81%A7Kafka+Topic%E3%81%AEKey%E3%82%92%E6%89%B1%E3%81%86+in+KSQL" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fconfluent-jp.github.io%2Fcommunity%2Fblog%2Fhandling-keys-in-ksql%2F&amp;t=%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E5%87%A6%E7%90%86%E3%81%A7Kafka+Topic%E3%81%AEKey%E3%82%92%E6%89%B1%E3%81%86+in+KSQL" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E5%87%A6%E7%90%86%E3%81%A7Kafka%20Topic%E3%81%AEKey%E3%82%92%E6%89%B1%E3%81%86%20in%20KSQL&amp;body=https%3A%2F%2Fconfluent-jp.github.io%2Fcommunity%2Fblog%2Fhandling-keys-in-ksql%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fconfluent-jp.github.io%2Fcommunity%2Fblog%2Fhandling-keys-in-ksql%2F&amp;title=%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E5%87%A6%E7%90%86%E3%81%A7Kafka+Topic%E3%81%AEKey%E3%82%92%E6%89%B1%E3%81%86+in+KSQL" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E5%87%A6%E7%90%86%E3%81%A7Kafka+Topic%E3%81%AEKey%E3%82%92%E6%89%B1%E3%81%86+in+KSQL%20https%3A%2F%2Fconfluent-jp.github.io%2Fcommunity%2Fblog%2Fhandling-keys-in-ksql%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fconfluent-jp.github.io%2Fcommunity%2Fblog%2Fhandling-keys-in-ksql%2F&amp;title=%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%A0%E5%87%A6%E7%90%86%E3%81%A7Kafka+Topic%E3%81%AEKey%E3%82%92%E6%89%B1%E3%81%86+in+KSQL" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://confluent-jp.github.io/community><img class="avatar mr-3 avatar-circle" src=/community/authors/hashi/avatar_hudc0c7c8d0c95e5f09e296b73be3a2ab5_129312_270x270_fill_q75_lanczos_center.jpg alt=hashi></a><div class=media-body><h5 class=card-title><a href=https://confluent-jp.github.io/community>hashi</a></h5><h6 class=card-subtitle>Admin - Manager, Solutions Engineering, Korea/Japan</h6><p class=card-text>畑Noob</p><ul class=network-icon aria-hidden=true><li><a href=https://twitter.com/ShinHashitani target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href=https://www.linkedin.com/in/shin-hashitani-570a399/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=https://github.com/shinichi-hashitani target=_blank rel=noopener><i class="fab fa-GitHub"></i></a></li></ul></div></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2023 Confluent Japan Community. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/community/js/vendor-bundle.min.938a3a7554cd9f6602290411f64d2617.js></script><script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script><script id=page-data type=application/json>{"use_headroom":true}</script><script src=/community/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script><script src=/community/en/js/wowchemy.min.3439793e6bad48850793e5ec2df3300d.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy
</a><a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/community/js/wowchemy-publication.9137013a66774049159934c29c3f0205.js type=module></script></body></html>